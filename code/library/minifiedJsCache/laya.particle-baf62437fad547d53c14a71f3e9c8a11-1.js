!function(t,e){"use strict";class EmitterBase{constructor(){this._frameTime=0,this._emissionRate=60,this._emissionTime=0,this.minEmissionTime=1/60}set particleTemplate(t){this._template=t}set emissionRate(t){t<=0||(this._emissionRate=t,t>0&&(this.minEmissionTime=1/t))}get emissionRate(){return this._emissionRate}start(t=Number.MAX_VALUE){0!=this._emissionRate&&(this._emissionTime=t)}stop(){this._emissionTime=0}clear(){this._emissionTime=0}emit(){}advanceTime(t=1){if(this._emissionTime-=t,!(this._emissionTime<0||(this._frameTime+=t,this._frameTime<this.minEmissionTime)))for(;this._frameTime>this.minEmissionTime;)this._frameTime-=this.minEmissionTime,this.emit()}}var i="attribute vec4 a_CornerTextureCoordinate;\r\nattribute vec3 a_Position;\r\nattribute vec3 a_Velocity;\r\nattribute vec4 a_StartColor;\r\nattribute vec4 a_EndColor;\r\nattribute vec3 a_SizeRotation;\r\nattribute vec2 a_Radius;\r\nattribute vec4 a_Radian;\r\nattribute float a_AgeAddScale;\r\nattribute float a_Time;\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\n\r\nuniform float u_CurrentTime;\r\nuniform float u_Duration;\r\nuniform float u_EndVelocity;\r\nuniform vec3 u_Gravity;\r\n\r\nuniform vec2 size;\r\nuniform mat4 u_mmat;\r\n\r\nvec4 ComputeParticlePosition(in vec3 position, in vec3 velocity,in float age,in float normalizedAge)\r\n{\r\n\r\n   float startVelocity = length(velocity);//起始标量速度\r\n   float endVelocity = startVelocity * u_EndVelocity;//结束标量速度\r\n\r\n   float velocityIntegral = startVelocity * normalizedAge +(endVelocity - startVelocity) * normalizedAge *normalizedAge/2.0;//计算当前速度的标量（单位空间），vt=v0*t+(1/2)*a*(t^2)\r\n   \r\n   vec3 addPosition = normalize(velocity) * velocityIntegral * u_Duration;//计算受自身速度影响的位置，转换标量到矢量    \r\n   addPosition += u_Gravity * age * normalizedAge;//计算受重力影响的位置\r\n   \r\n   float radius=mix(a_Radius.x, a_Radius.y, normalizedAge); //计算粒子受半径和角度影响（无需计算角度和半径时，可用宏定义优化屏蔽此计算）\r\n   float radianHorizontal =mix(a_Radian.x,a_Radian.z,normalizedAge);\r\n   float radianVertical =mix(a_Radian.y,a_Radian.w,normalizedAge);\r\n   \r\n   float r =cos(radianVertical)* radius;\r\n   addPosition.y += sin(radianVertical) * radius;\r\n\t\r\n   addPosition.x += cos(radianHorizontal) *r;\r\n   addPosition.z += sin(radianHorizontal) *r;\r\n  \r\n   addPosition.y=-addPosition.y;//2D粒子位置更新需要取负，2D粒子坐标系Y轴正向朝上\r\n   position+=addPosition;\r\n   return  vec4(position,1.0);\r\n}\r\n\r\nfloat ComputeParticleSize(in float startSize,in float endSize, in float normalizedAge)\r\n{    \r\n    float size = mix(startSize, endSize, normalizedAge);\r\n    return size;\r\n}\r\n\r\nmat2 ComputeParticleRotation(in float rot,in float age)\r\n{    \r\n    float rotation =rot * age;\r\n    //计算2x2旋转矩阵.\r\n    float c = cos(rotation);\r\n    float s = sin(rotation);\r\n    return mat2(c, -s, s, c);\r\n}\r\n\r\nvec4 ComputeParticleColor(in vec4 startColor,in vec4 endColor,in float normalizedAge)\r\n{\r\n\tvec4 color=mix(startColor,endColor,normalizedAge);\r\n    //硬编码设置，使粒子淡入很快，淡出很慢,6.7的缩放因子把置归一在0到1之间，可以谷歌x*(1-x)*(1-x)*6.7的制图表\r\n    color.a *= normalizedAge * (1.0-normalizedAge) * (1.0-normalizedAge) * 6.7;\r\n   \r\n    return color;\r\n}\r\n\r\nvoid main()\r\n{\r\n   float age = u_CurrentTime - a_Time;\r\n   age *= 1.0 + a_AgeAddScale;\r\n   float normalizedAge = clamp(age / u_Duration,0.0,1.0);\r\n   gl_Position = ComputeParticlePosition(a_Position, a_Velocity, age, normalizedAge);//计算粒子位置\r\n   float pSize = ComputeParticleSize(a_SizeRotation.x,a_SizeRotation.y, normalizedAge);\r\n   mat2 rotation = ComputeParticleRotation(a_SizeRotation.z, age);\r\n\t\r\n    mat4 mat=u_mmat;\r\n    gl_Position=vec4((mat*gl_Position).xy,0.0,1.0);\r\n    gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize*vec2(mat[0][0],mat[1][1]);\r\n    gl_Position=vec4((gl_Position.x/size.x-0.5)*2.0,(0.5-gl_Position.y/size.y)*2.0,0.0,1.0);\r\n   \r\n   v_Color = ComputeParticleColor(a_StartColor,a_EndColor, normalizedAge);\r\n   v_TextureCoordinate =a_CornerTextureCoordinate.zw;\r\n}\r\n\r\n",r="#if defined(GL_FRAGMENT_PRECISION_HIGH)\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\nuniform sampler2D u_texture;\r\n\r\nvoid main()\r\n{\t\r\n\tgl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\r\n\tgl_FragColor.xyz *= v_Color.w;\r\n}";class ParticleShader extends e.Shader{constructor(){super(i,r,"ParticleShader",null,["a_CornerTextureCoordinate",0,"a_Position",1,"a_Velocity",2,"a_StartColor",3,"a_EndColor",4,"a_SizeRotation",5,"a_Radius",6,"a_Radian",7,"a_AgeAddScale",8,"a_Time",9])}}ParticleShader.vs=i,ParticleShader.ps=r;class ParticleShaderValue extends e.Value2D{constructor(){super(0,0),ParticleShaderValue.pShader||(ParticleShaderValue.pShader=new ParticleShader)}upload(){var t=this.size;t[0]=e.RenderState2D.width,t[1]=e.RenderState2D.height,this.alpha=this.ALPHA*e.RenderState2D.worldAlpha,ParticleShaderValue.pShader.upload(this)}}ParticleShaderValue.pShader=null;class ParticleData{constructor(){}static create(t,i,r,a){var s=new ParticleData;s.position=i,e.MathUtil.scaleVector3(r,t.emitterVelocitySensitivity,ParticleData._tempVelocity);var n,o=e.MathUtil.lerp(t.minHorizontalVelocity,t.maxHorizontalVelocity,Math.random()),l=Math.random()*Math.PI*2;if(ParticleData._tempVelocity[0]+=o*Math.cos(l),ParticleData._tempVelocity[2]+=o*Math.sin(l),ParticleData._tempVelocity[1]+=e.MathUtil.lerp(t.minVerticalVelocity,t.maxVerticalVelocity,Math.random()),s.velocity=ParticleData._tempVelocity,s.startColor=ParticleData._tempStartColor,s.endColor=ParticleData._tempEndColor,t.disableColor){for(n=0;n<3;n++)s.startColor[n]=1,s.endColor[n]=1;s.startColor[n]=e.MathUtil.lerp(t.minStartColor[n],t.maxStartColor[n],Math.random()),s.endColor[n]=e.MathUtil.lerp(t.minEndColor[n],t.maxEndColor[n],Math.random())}else if(t.colorComponentInter)for(n=0;n<4;n++)s.startColor[n]=e.MathUtil.lerp(t.minStartColor[n],t.maxStartColor[n],Math.random()),s.endColor[n]=e.MathUtil.lerp(t.minEndColor[n],t.maxEndColor[n],Math.random());else e.MathUtil.lerpVector4(t.minStartColor,t.maxStartColor,Math.random(),s.startColor),e.MathUtil.lerpVector4(t.minEndColor,t.maxEndColor,Math.random(),s.endColor);s.sizeRotation=ParticleData._tempSizeRotation;var h=Math.random();s.sizeRotation[0]=e.MathUtil.lerp(t.minStartSize,t.maxStartSize,h),s.sizeRotation[1]=e.MathUtil.lerp(t.minEndSize,t.maxEndSize,h),s.sizeRotation[2]=e.MathUtil.lerp(t.minRotateSpeed,t.maxRotateSpeed,Math.random()),s.radius=ParticleData._tempRadius;var m=Math.random();s.radius[0]=e.MathUtil.lerp(t.minStartRadius,t.maxStartRadius,m),s.radius[1]=e.MathUtil.lerp(t.minEndRadius,t.maxEndRadius,m),s.radian=ParticleData._tempRadian,s.radian[0]=e.MathUtil.lerp(t.minHorizontalStartRadian,t.maxHorizontalStartRadian,Math.random()),s.radian[1]=e.MathUtil.lerp(t.minVerticalStartRadian,t.maxVerticalStartRadian,Math.random());var c=t.useEndRadian;return s.radian[2]=c?e.MathUtil.lerp(t.minHorizontalEndRadian,t.maxHorizontalEndRadian,Math.random()):s.radian[0],s.radian[3]=c?e.MathUtil.lerp(t.minVerticalEndRadian,t.maxVerticalEndRadian,Math.random()):s.radian[1],s.durationAddScale=t.ageAddScale*Math.random(),s.time=a,s}}ParticleData._tempVelocity=new Float32Array(3),ParticleData._tempStartColor=new Float32Array(4),ParticleData._tempEndColor=new Float32Array(4),ParticleData._tempSizeRotation=new Float32Array(3),ParticleData._tempRadius=new Float32Array(2),ParticleData._tempRadian=new Float32Array(4);class ParticleTemplate2D extends e.Resource{constructor(t,i){super(),this._floatCountPerVertex=29,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this.x=0,this.y=0,this.sv=new ParticleShaderValue,this._key={},this.settings=t,this.texture=i,this.texture._addReference(),this.sv.u_Duration=this.settings.duration,this.sv.u_Gravity=this.settings.gravity,this.sv.u_EndVelocity=this.settings.endVelocity,this._blendFn=e.BlendMode.fns[t.blendState],this._mesh=e.MeshParticle2D.getAMesh(this.settings.maxPartices),this.initialize()}getRenderType(){return-111}releaseRender(){}initialize(){var t;this._vertices=this._mesh._vb.getFloat32Array(),t=this._mesh._stride/4;for(var e=0,i=0,r=0;r<this.settings.maxPartices;r++){var a,s=Math.random(),n=this.settings.textureCount?1/this.settings.textureCount:1;for(a=0;a<this.settings.textureCount&&!(s<a+n);a+=n);this._vertices[e++]=-1,this._vertices[e++]=-1,this._vertices[e++]=0,this._vertices[e++]=a,e=i+=t,this._vertices[e++]=1,this._vertices[e++]=-1,this._vertices[e++]=1,this._vertices[e++]=a,e=i+=t,this._vertices[e++]=1,this._vertices[e++]=1,this._vertices[e++]=1,this._vertices[e++]=a+n,e=i+=t,this._vertices[e++]=-1,this._vertices[e++]=1,this._vertices[e++]=0,this._vertices[e++]=a+n,e=i+=t}}addParticleArray(t,e){t[0]+=this.x,t[1]+=this.y;var i=this._firstFreeElement+1;if(i>=this.settings.maxPartices&&(i=0),i!==this._firstRetiredElement){for(var r=ParticleData.create(this.settings,t,e,this._currentTime),a=this._firstFreeElement*this._floatCountPerVertex*4,s=0;s<4;s++){var n,o;for(n=0,o=4;n<3;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.position[n];for(n=0,o=7;n<3;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.velocity[n];for(n=0,o=10;n<4;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.startColor[n];for(n=0,o=14;n<4;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.endColor[n];for(n=0,o=18;n<3;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.sizeRotation[n];for(n=0,o=21;n<2;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.radius[n];for(n=0,o=23;n<4;n++)this._vertices[a+s*this._floatCountPerVertex+o+n]=r.radian[n];this._vertices[a+s*this._floatCountPerVertex+27]=r.durationAddScale,this._vertices[a+s*this._floatCountPerVertex+28]=r.time}this._firstFreeElement=i}}addNewParticlesToVertexBuffer(){var t,e=this._mesh._vb;e.buffer2D.clear(),e.buffer2D.append(this._vertices),this._firstNewElement<this._firstFreeElement?(t=4*this._firstNewElement*this._floatCountPerVertex*4,e.buffer2D.subUpload(t,t,t+4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex*4)):(t=4*this._firstNewElement*this._floatCountPerVertex*4,e.buffer2D.subUpload(t,t,t+4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex*4),this._firstFreeElement>0&&(e.buffer2D.setNeedUpload(),e.buffer2D.subUpload(0,0,4*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement}renderSubmit(){return this.texture&&this.texture.valid&&(this.update(e.ILaya.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this.blend(),this._firstActiveElement!=this._firstFreeElement&&(this._mesh.useMesh(),this.sv.u_texture=this.texture._getSource(),this.sv.upload(),this._firstActiveElement<this._firstFreeElement?e.LayaGL.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,6*(this._firstFreeElement-this._firstActiveElement),e.IndexFormat.UInt16,6*this._firstActiveElement*2):(e.LayaGL.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,6*(this.settings.maxPartices-this._firstActiveElement),e.IndexFormat.UInt16,6*this._firstActiveElement*2),this._firstFreeElement>0&&e.LayaGL.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,6*this._firstFreeElement,e.IndexFormat.UInt16,0))),this._drawCounter++),1}updateParticleForNative(){this.texture&&this.texture.valid&&(this.update(e.ILaya.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&(this._firstNewElement=this._firstFreeElement))}update(t){this._currentTime+=t/1e3,this.retireActiveParticles(),this.freeRetiredParticles(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0)}retireActiveParticles(){for(var t=this.settings.duration;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*4,i=e+28,r=this._currentTime-this._vertices[i];if((r*=1+this._vertices[e+27])+1e-4<t)break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.settings.maxPartices&&(this._firstActiveElement=0)}}freeRetiredParticles(){for(;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+28]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.settings.maxPartices&&(this._firstRetiredElement=0)}}getMesh(){return this._mesh}getConchMesh(){return this._conchMesh}getFirstNewElement(){return this._firstNewElement}getFirstFreeElement(){return this._firstFreeElement}getFirstActiveElement(){return this._firstActiveElement}getFirstRetiredElement(){return this._firstRetiredElement}setFirstFreeElement(t){this._firstFreeElement=t}setFirstNewElement(t){this._firstNewElement=t}addDrawCounter(){this._drawCounter++}blend(){e.BlendMode.activeBlendFunction!==this._blendFn&&(e.RenderStateContext.setBlend(!0),this._blendFn(),e.BlendMode.activeBlendFunction=this._blendFn)}_disposeResource(){this.texture._removeReference(),this._mesh.releaseMesh()}}ParticleTemplate2D.activeBlendType=-1;class Emitter2D extends EmitterBase{constructor(t){super(),this.template=t}set template(t){this._template=t,t||(this._emitFun=null,this.setting=null,this._posRange=null),this.setting=t.settings,this._posRange=this.setting.positionVariance,this._template instanceof ParticleTemplate2D&&(this._emitFun=this.webGLEmit)}get template(){return this._template}emit(){super.emit(),null!=this._emitFun&&this._emitFun()}getRandom(t){return(2*Math.random()-1)*t}webGLEmit(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._template.addParticleArray(t,e)}canvasEmit(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._template.addParticleArray(t,e)}}class Particle2D extends e.Sprite{constructor(){super(),this._matrix4=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.autoPlay=!0,this.customRenderEnable=!0}get source(){return this._source}set source(t){this._source=t,t?e.ILaya.loader.load(t).then((t=>{t&&!t.isCreateFromURL(this._source)||this.init(t)})):this.init(null)}get template(){return this._template}set template(t){this.init(t)}get emitter(){return this._emitter}init(t){this._template&&this.reset(),this._template=t,this._template&&(this._template._addReference(),this.customRenderEnable=!0,this.graphics.addCmd(e.DrawParticleCmd.create(this._template)),this._emitter?this._emitter.template=this._template:this._emitter=new Emitter2D(this._template),this.autoPlay&&(this.emitter.start(),this.play()))}play(){e.ILaya.timer.frameLoop(1,this,this._loop)}stop(){e.ILaya.timer.clear(this,this._loop)}_loop(){this.advanceTime(1/60)}advanceTime(t=1){this._canvasTemplate&&this._canvasTemplate.advanceTime(t),this._emitter&&this._emitter.advanceTime(t)}customRender(t,e,i){(this._matrix4[0]=t._curMat.a,this._matrix4[1]=t._curMat.b,this._matrix4[4]=t._curMat.c,this._matrix4[5]=t._curMat.d,this._matrix4[12]=t._curMat.tx,this._matrix4[13]=t._curMat.ty,this._template)&&(this._template.sv.u_mmat=this._matrix4,this._canvasTemplate&&this._canvasTemplate.render(t,e,i))}reset(){this.stop()}destroy(t=!0){super.destroy(t),this._template&&this.reset()}}class ParticleSetting{constructor(){this.textureName=null,this.textureCount=1,this.maxPartices=100,this.duration=1,this.ageAddScale=0,this.emitterVelocitySensitivity=1,this.minStartSize=100,this.maxStartSize=100,this.minEndSize=100,this.maxEndSize=100,this.minHorizontalVelocity=0,this.maxHorizontalVelocity=0,this.minVerticalVelocity=0,this.maxVerticalVelocity=0,this.endVelocity=1,this.gravity=new Float32Array([0,0,0]),this.minRotateSpeed=0,this.maxRotateSpeed=0,this.minStartRadius=0,this.maxStartRadius=0,this.minEndRadius=0,this.maxEndRadius=0,this.minHorizontalStartRadian=0,this.maxHorizontalStartRadian=0,this.minVerticalStartRadian=0,this.maxVerticalStartRadian=0,this.useEndRadian=!0,this.minHorizontalEndRadian=0,this.maxHorizontalEndRadian=0,this.minVerticalEndRadian=0,this.maxVerticalEndRadian=0,this.minStartColor=new Float32Array([1,1,1,1]),this.maxStartColor=new Float32Array([1,1,1,1]),this.minEndColor=new Float32Array([1,1,1,1]),this.maxEndColor=new Float32Array([1,1,1,1]),this.colorComponentInter=!1,this.disableColor=!1,this.blendState=0,this.emitterType="null",this.emissionRate=0,this.pointEmitterPosition=new Float32Array([0,0,0]),this.pointEmitterPositionVariance=new Float32Array([0,0,0]),this.pointEmitterVelocity=new Float32Array([0,0,0]),this.pointEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.boxEmitterCenterPosition=new Float32Array([0,0,0]),this.boxEmitterSize=new Float32Array([0,0,0]),this.boxEmitterVelocity=new Float32Array([0,0,0]),this.boxEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.sphereEmitterCenterPosition=new Float32Array([0,0,0]),this.sphereEmitterRadius=1,this.sphereEmitterVelocity=0,this.sphereEmitterVelocityAddVariance=0,this.ringEmitterCenterPosition=new Float32Array([0,0,0]),this.ringEmitterRadius=30,this.ringEmitterVelocity=0,this.ringEmitterVelocityAddVariance=0,this.ringEmitterUp=2,this.positionVariance=new Float32Array([0,0,0])}}const a=new ParticleSetting;function checkSetting(t){var e;for(e in a)e in t||(t[e]=a[e]);return t.endVelocity=+t.endVelocity,t.gravity[0]=+t.gravity[0],t.gravity[1]=+t.gravity[1],t.gravity[2]=+t.gravity[2],t}e.Loader.registerLoader(["part"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.2),t.options).then((e=>{if(!e)return null;let i=checkSetting(e);return t.loader.load(i.textureName,t.options,t.progress.createCallback()).then((t=>t?new ParticleTemplate2D(i,t):null))}))}}),(0,e.ClassUtils.regClass)("Particle2D",Particle2D);t.Emitter2D=Emitter2D,t.EmitterBase=EmitterBase,t.Particle2D=Particle2D,t.ParticleData=ParticleData,t.ParticleEmitter=class{constructor(t,e,i){this._timeLeftOver=0,this._tempVelocity=new Float32Array([0,0,0]),this._tempPosition=new Float32Array([0,0,0]),this._templet=t,this._timeBetweenParticles=1/e,this._previousPosition=i}update(t,i){if((t/=1e3)>0){e.MathUtil.subtractVector3(i,this._previousPosition,this._tempVelocity),e.MathUtil.scaleVector3(this._tempVelocity,1/t,this._tempVelocity);for(var r=this._timeLeftOver+t,a=-this._timeLeftOver;r>this._timeBetweenParticles;)a+=this._timeBetweenParticles,r-=this._timeBetweenParticles,e.MathUtil.lerpVector3(this._previousPosition,i,a/t,this._tempPosition),this._templet.addParticleArray(this._tempPosition,this._tempVelocity);this._timeLeftOver=r}this._previousPosition[0]=i[0],this._previousPosition[1]=i[1],this._previousPosition[2]=i[2]}},t.ParticleSetting=ParticleSetting,t.ParticleShader=ParticleShader,t.ParticleShaderValue=ParticleShaderValue,t.ParticleTemplate2D=ParticleTemplate2D,t.checkSetting=checkSetting}(window.Laya=window.Laya||{},Laya);
//# sourceMappingURL=laya.particle.js.map